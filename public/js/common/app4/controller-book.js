/*! (C) 2017 https://github.com/ikarus512 */!function(){"use strict";function o(o,n,e,i,r,t,a,d,c,u){function s(n){o.bookId&&(o.ajaxLoadingSpinner++,i.getBook(o.bookId).then(function(e){o.curBook;var i=e.data;if(o.curBook||(o.curBook={}),n&&n.details&&i){o.curBook.title=i.title,o.curBook._id=i._id,o.curBook.price=i.price,o.curBook.ownerId=i.ownerId,o.curBook.ownerName=i.ownerName,o.curBook.keywords=i.keywords,o.curBook.description=i.description,o.curBook.photoId=i.photoId,o.curBook.tradeFinished=i.tradeFinished;var r=String(o.curBook.description);r.length>200&&(o.curBook.descriptionShort=r.substr(0,200),o.curBook.short=!0)}n&&n.bids&&i&&i.bids&&(o.curBook.bids||(o.curBook.bids=[]),i.bids.forEach(function(n){var e;o.curBook.bids.some(function(o,i){return e=i,o._id===n._id})?o.curBook.bids[e].price=n.price:o.curBook.bids.push(n)}),o.curBook.bids.forEach(function(o){o.msgs||(o.msgs=[])}),o.curBook.bids.forEach(function(o){o.updateBidPrice=o.price}),o.curBook.hasBid=o.curBook.bids.some(function(n,e){var i=n.by._id===o.uid;return i&&(n.focusMe||(n.focusMe=!0)),i})),n&&!n.noreset&&o.bookEditCancelChanges()}).catch(function(n){o.curBook=null,o.newBook=null,t.alert(n)}).then(function(){o.ajaxLoadingSpinner++,r.subscribe(o.bookId,o.uid,k).finally(function(){o.ajaxLoadingSpinner--})}).finally(function(){o.ajaxLoadingSpinner--}))}function k(n){var e,i;if("app4-broadcast-refresh-bids"===n.msgtype)s({bids:1});else if("app4-broadcast-refresh-details"===n.msgtype)s({details:1});else if("app4-message"===n.msgtype){if(o.curBook.ownerId===n.to){e=n.from;var r;o.curBook.bids.some(function(o){return r=o.by.name,o.by._id===e}),i={_id:n.from,name:r}}else e=n.to,i={_id:n.from,name:o.curBook.ownerName};var t;if(o.curBook.bids.some(function(o,n){return t=n,o.by._id===e})){var a={by:i,at:n.time,text:n.text};o.curBook.bids[t].msgs.push(a),o.curBook.ownerId===n.to?o.curBook.bids[t].showOwnerTalk=!0:o.curBook.bids[t].showBidderTalk=!0,o.$apply()}}}o.ajaxLoadingSpinner=0,o.urlPrefix=d.urlPrefix,o.serverUrl=d.serverUrl,o.addBid=function(){o.ajaxLoadingSpinner++,i.addBid(o.curBook._id,o.newBidPrice).catch(function(o){t.alert(o)}).finally(function(){o.ajaxLoadingSpinner--})},o.bookDelete=function(){o.newBook&&confirm("Do you really want to delete the book?")&&(o.ajaxLoadingSpinner++,i.bookDelete(o.newBook._id).then(function(n){o.goBooksPage()}).catch(function(o){t.alert(o)}).finally(function(){o.ajaxLoadingSpinner--}))},o.bookEditCancelChanges=function(){o.curBook&&(o.newBook={},o.newBook.title=o.curBook.title,o.newBook._id=o.curBook._id,o.newBook.price=o.curBook.price,o.newBook.ownerId=o.curBook.ownerId,o.newBook.ownerName=o.curBook.ownerName,o.newBook.keywords=o.curBook.keywords,o.newBook.description=o.curBook.description,o.newBook.photoId=o.curBook.photoId,o.clearFile())},o.bookSaveChanges=function(){o.newBook.title=o.newBook.title.trim(),o.newBook.keywords=o.newBook.keywords.trim(),o.newBook.description=o.newBook.description.trim(),o.newBook.title&&(o.ajaxLoadingSpinner++,i.postBook(o.newBook).catch(function(o){t.alert(o)}).finally(function(){o.ajaxLoadingSpinner--}))},o.chooseBid=function(n){confirm("Do you really want to finish trade with price $"+n.price+"?")&&(o.ajaxLoadingSpinner++,i.chooseBid(o.curBook._id,n.by._id).catch(function(o){t.alert(o)}).finally(function(){o.ajaxLoadingSpinner--}))},o.clearFile=function(){o.myBookEditForm.file.$setValidity("maxSize",!0),o.newBook.file=null},o.goBooksPage=function(){n.location.href=d.urlPrefix+"/app4/books"},o.sendMsg=function(n,e,i){if(n.newMsg){var t={by:{_id:o.uid,name:o.username},at:new Date,text:n.newMsg};r.sendMessage(o.curBook._id,e,i,new Date,n.newMsg),n.msgs.push(t),n.newMsg=""}},o.updateBid=function(n,e,r){n&&e!==r&&(o.ajaxLoadingSpinner++,i.addBid(o.curBook._id,r).catch(function(o){t.alert(o)}).finally(function(){o.ajaxLoadingSpinner--}))},d.webApp?(o.logintype=u.logintype&&"undefined"!==u.logintype?u.logintype:"",o.username=u.username&&"undefined"!==u.username?u.username:"",o.uid=u.uid&&"undefined"!==u.uid?u.uid:"",o.bookId=u.bookId&&"undefined"!==u.bookId?u.bookId:""):(o.ajaxLoadingSpinner++,c.check().then(function(){o.logintype=c.type,o.username=c.name,o.uid=c.uid}).finally(function(){o.ajaxLoadingSpinner--}),o.bookId=a.bookId),s({details:1,bids:1}),o.$on("$destroy",function(){r.close()})}angular.module("app4book").controller("myApp4ControllerBook",o),o.$inject=["$scope","$window","$timeout","bookStorage","App4WebSocketService","MyError","$routeParams","MyConst","User","backendParams"]}();