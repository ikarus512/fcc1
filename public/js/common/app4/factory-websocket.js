/*! (C) 2017 https://github.com/ikarus512 */!function(){"use strict";angular.module("app4book").factory("App4WebSocketService",["bookStorage","MyError","MyConst","$q",function(e,t,o,n){var c={},r=null;return c.subscribe=function(a,i,s){var u=n.defer();return c.callback=s,c.close(),r=new WebSocket(o.webSocketHost),r.onopen=function(o){e.getWsTicket().then(function(e){var t="object"==typeof e&&e.data&&e.data.ticket?e.data.ticket:"";setTimeout(function(){r.send(JSON.stringify({msgtype:"app4-check-ticket",bookId:a,uid:i,ticket:t})),u.resolve(1)},1500)}).catch(function(e){u.reject(0),t.log(e)})},r.onerror=function(e){u.reject(0)},r.onclose=function(e){u.reject(0)},r.onmessage=function(e){var t=JSON.parse(e.data);c.callback(t)},u.promise},c.sendMessage=function(e,t,o,n,c){r.send(JSON.stringify({msgtype:"app4-message",bookId:e,from:t,to:o,time:n,text:c}))},c.close=function(){r&&(r.close(),r=null)},c}])}();