/*! (C) 2017 https://github.com/ikarus512 */!function(){"use strict";angular.module("app2").directive("myGoogleMap",function(){return{restrict:"E",template:"<div id='gmaps'></div>",replace:!0,scope:{cafes:"=mapCafes",selectedCafeId:"=mapSelectedCafeId",center:"=mapCenter",zoom:"=mapZoom",mapMoved:"=",onMapInit:"=",mapSelectedCafe:"=",cafesUnselect:"="},link:function(e,n,t){function o(n,t,o){a(),p=n,n.setIcon("https://maps.google.com/mapfiles/ms/icons/red-dot.png"),o&&e.$apply(function(){e.mapSelectedCafe(t)})}function a(){p&&(p.setIcon("https://maps.google.com/mapfiles/ms/icons/blue-dot.png"),p=null)}function c(n){a(),e.$apply(function(){e.cafesUnselect()})}function i(e){d.setZoom(d.getZoom()+1),setTimeout(function(){d.setCenter(e.latLng),s()},100)}function l(){var n=new google.maps.LatLng(e.center.lat,e.center.lng);setTimeout(function(){d.setCenter(n),s()},100)}function s(){L&&(L=!1,setTimeout(function(){var n=d.getZoom(),t=d.getCenter(),o=d.getBounds();if(o){var a=new google.maps.LatLng(o.f.f,o.b.b),c=new google.maps.LatLng(o.f.b,o.b.b),i=new google.maps.LatLng(o.f.f,o.b.f),l=(new google.maps.LatLng(o.f.b,o.b.f),google.maps.geometry.spherical.computeDistanceBetween(a,c)),s=google.maps.geometry.spherical.computeDistanceBetween(a,i);o=.5*Math.min(l,s)*.95}else o=500;e.$apply(function(){e.mapMoved({newZoom:n,newRadius:o,newCenter:{lat:t.lat(),lng:t.lng()}})}),f.setCenter(t),f.setRadius(o),L=!0},500))}function r(e){var n=h[e._id];n===p&&a(),google.maps.event.removeListener(n.myMarkerListenerHandle),n.setMap(null),delete h[e._id],n=null}function m(n){var t=1e-4*Math.pow(2,16-e.zoom);return{lat:n.lat-t,lng:n.lng-t}}function g(n){var t,a={lat:n.lat,lng:n.lng};e.cafes.forEach(function(e){try{var t=h[e._id];t&&e._id!==n._id&&google.maps.geometry.spherical.computeDistanceBetween(t.position,new google.maps.LatLng(a.lat,a.lng))<20&&(a=m(a)),t=null}catch(e){}});var c={position:a,map:d,title:n.name,icon:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png"};(t=new google.maps.Marker(c)).myMarkerListenerHandle=google.maps.event.addListener(t,"click",function(){o(h[n._id],n._id,!0)}),h[n._id]=t}var d,p,f,u=!1,L=!0,h={},C={center:e.center,zoom:e.zoom,mapTypeId:google.maps.MapTypeId.ROADMAP,fullscreenControl:!0,mapTypeControl:!0,scaleControl:!0,zoomControl:!0,disableDoubleClickZoom:!0};d||((d=new google.maps.Map(n[0],C)).addListener("dragend",s),d.addListener("zoom_changed",s),d.addListener("center_changed",s),d.addListener("dblclick",i),d.addListener("click",c),$(document).on("webkitfullscreenchange mozfullscreenchange msfullscreenchange fullscreenchange",l),d.addListener("idle",function(n){u||(u=!0,setTimeout(function(){e.onMapInit()},100),s())}),(f=new google.maps.Circle({strokeColor:"#FF0000",strokeOpacity:.3,strokeWeight:2,fillColor:"#00FF00",fillOpacity:.1,map:d,center:new google.maps.LatLng(e.center.lat,e.center.lng),radius:e.radius?e.radius:1e4})).addListener("dblclick",i),f.addListener("click",c),e.cafes.forEach(function(e){g(e)})),e.$watchCollection("cafes",function(e,n){n.forEach(function(n){e.some(function(e){return e._id===n._id})||r(n)}),e.forEach(function(e){n.some(function(n){return e._id===n._id})||g(e)})}),e.$watch("selectedCafeId",function(n){n&&"undefined"!==n?e.cafes.some(function(e){return!!e.selected&&(o(h[e._id],e._id,!1),!0)}):a()})}}})}();